---
title: "Analyzing count data with Stan"
author: "John Johnson"
date: '2018-04-03'
slug: analyzing-count-data-with-stan
categories:
  - Greenville
tags:
  - Bayesian
  - flights
  - Stan
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(rstan)
library(bayesplot)
load("airline_data.RData")
airline_data %>% 
  mutate(date=ymd(YEAR*10000+MONTH*100+DAY_OF_MONTH),
         wnum = floor((date - ymd(YEAR*10000+0101))/7)) -> 
  airline_data

airline_data %>% 
  filter(ORIGIN_AIRPORT_ID==11996) %>% 
  count(date) -> 
  counts_depart
```

```{r mc_cores}
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

# Purpose

In the last few posts, we have built a rather sophisticated linear model using Stan. This model investigates the patterns in flight departure data over the course of a year. We started with a very simple model - that the flights could be modeled by a single number plus some noise. Over time, we have built up to a model that involves a single number ("overall mean" if you will), a day of the week effect, and a quarter effect. We chose day of the week because we reviewed a line graph of the data, and we took some cues from our domain knowledge (i.e. that the demand for flights depends roughly on quarter and on day of the week).

However, we modeled the number of flights as a normal distribution. While the normal distribution is very convenient mathematically, it assumes that the number of flights is continuous. This is absurd. Now, we use the negative binomial model to account for the fact that we are working with count data.

<!--more-->

# Modeling counts

Right now, if you are curious about the math, we have a model that looks like the following:

$$flights = \mu + q_i + w_j + \epsilon \left(i\in \left\{1,2,3,4\right\}, j\in\left\{1,2,3,4,5,6,7\right\},\sum_{i=1}^4q_i=0,\sum_{j=1}^7w_j=0\right)$$

This part of the model doesn't change. What changes is that the noise $\epsilon$ changes distribution. 

<!--START HERE-->

# Discussion

We changed our model slightly to account for the fact that flights are counts rather than continuous. In effect, we have built up from a very simple model that you might encounter in a Statistics 101 class to a rather sophisticated generalized linear model that you might encounter after a couple of years in statistics. Because we built this up in Stan, we used computer code that resembles the math and got results that are straightforward to interpret.

This is probably the right point to mention the `rstanarm` package, which implements a lot of common statistical models including the generalized linear models. Especially if you are starting out with using Stan and need to use it for some modeling right now, you probably want to look into it. The main reason is that `rstanarm` uses a few tricks and reparameterizations to make the Markov chain Monte Carlo sampling more efficient and less risky. In addition, you won't have to code the Stan model yourself, and yet you get the benefit of the Bayesian analysis.